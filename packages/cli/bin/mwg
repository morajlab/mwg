#!/usr/bin/env bash

ROOT_PATH=$(dirname $(dirname $(dirname $(dirname $0))))
TEMPLATES_PATH=$ROOT_PATH/packages/templates.list.d

g() {
  generate "$@"
}
generate() {
  local template=
  local workspace_name='workspace_name'
  local workspace_description='workspace description'
  local path=$(pwd)

  shift

  while [ "$#" -gt 0 ]; do
    if [ -z $template ]; then
      if [ ! -d "$TEMPLATES_PATH/$1" ]; then
        echo ">>> ERROR  :: template '$1' does not exist."
        exit 1
      fi

      template=$1

      shift
      continue
    fi

    case "${1^^}" in
      "--DESCRIPTION" | "-D")
        workspace_description=$2

        shift
        shift
      ;;
      "--NAME" | "-N")
        workspace_name=$2

        shift
        shift
      ;;
      "--PATH" | "-P")
        path=$2

        shift
        shift
      ;;
      *)
        shift
      ;;
    esac
  done

  TMP_DIR=$(mktemp -d)

  cp -r "$TEMPLATES_PATH/$template" "$TMP_DIR" && \
  bash "$TMP_DIR/$template/generate.sh" \
    --name "$workspace_name" --desc "$workspace_description" && \
  cp -r "$TMP_DIR/$template/files" "$path" && \
  rm -rf "$TMP_DIR" && \
  echo ">>> SUCCESS:: workspace generated at '$path'"
}

list() {
  local search_path=$TEMPLATES_PATH
  local user_temp_list_path=/etc/mwg/templates.list.d
  local show_path=1

  if [ -d "$user_temp_list_path" ]; then
    search_path+=" $user_temp_list_path"
  fi

  while [ "$#" -gt 0 ]; do
    case "${1^^}" in
      "--PATH" | "-P")
        show_path=0

        shift
      ;;
      *)
        shift
      ;;
    esac
  done

  while IFS= read -r template; do
    if [[ $show_path = 0 ]]; then
      realpath $template
    else
      # TODO: show templates information in table
      echo
    fi
  done < <(find $search_path -name '*.mwg')
}
l() {
  list "$@"
}

$1 "$@"
